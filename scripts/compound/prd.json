{
  "project": "Margin Swift Rebuild",
  "branchName": "compound/swift-critical-fixes",
  "description": "Fix 6 critical data-loss, crash, and security issues in the Swift rebuild",
  "tasks": [
    {
      "id": "T-001",
      "title": "Fix tab dirty flag sync to prevent silent data loss on tab close",
      "description": "AppState.isDirty is updated on content changes but never synced to the active TabItem.isDirty. closeTab checks tab.isDirty (always false) so the unsaved-changes dialog never triggers. Sync isDirty to the active tab whenever it changes.",
      "acceptanceCriteria": [
        "Run `cd Margin && swift build` - exits with code 0",
        "File `Margin/Sources/Margin/AppState.swift` contains code that sets the active tab's isDirty when global isDirty changes",
        "File `Margin/Sources/Margin/Models/TabItem.swift` has isDirty as a mutable var"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "T-002",
      "title": "Fix keep-local article save to not silently discard edits",
      "description": "saveCurrentFile() clears isDirty and returns when filePath is nil (keep-local articles). This makes the user think their edits were saved. Instead, do NOT clear isDirty when there's no file path, so the unsaved-changes guard still triggers on tab close.",
      "acceptanceCriteria": [
        "Run `cd Margin && swift build` - exits with code 0",
        "File `Margin/Sources/Margin/AppState.swift` does NOT clear isDirty when filePath is nil in saveCurrentFile"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "T-003",
      "title": "Fix JSONL correction export to not silently drop records",
      "description": "CorrectionStore JSONL export uses String? as Any which causes JSONSerialization to fail. try? swallows the error. Fix by using proper nil handling and let errors propagate.",
      "acceptanceCriteria": [
        "Run `cd Margin && swift build` - exits with code 0",
        "File `Margin/Sources/Margin/Database/CorrectionStore.swift` does not contain `as Any` for optional String fields in the JSONL export section",
        "File `Margin/Sources/Margin/Database/CorrectionStore.swift` does not use `try?` for JSON serialization in the JSONL section"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "T-004",
      "title": "Fix mdfind query injection by escaping user input",
      "description": "SearchStore.searchFilesOnDisk interpolates user query directly into mdfind predicate string. Single quotes, backslashes, and special chars can break or inject commands. Escape the query before interpolation.",
      "acceptanceCriteria": [
        "Run `cd Margin && swift build` - exits with code 0",
        "File `Margin/Sources/Margin/Database/SearchStore.swift` escapes or sanitizes the query string before passing to mdfind"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "T-005",
      "title": "Fix highlight reapply to preserve code block backgrounds",
      "description": "MarkdownEditorView.applyHighlights removes ALL .backgroundColor attributes from the full text range, which destroys code block formatting. Instead, only remove backgrounds matching known highlight colors.",
      "acceptanceCriteria": [
        "Run `cd Margin && swift build` - exits with code 0",
        "File `Margin/Sources/Margin/Views/Editor/MarkdownEditorView.swift` does not remove .backgroundColor from the entire text range indiscriminately"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "T-006",
      "title": "Fix FTS5 search query rank syntax",
      "description": "SearchStore.searchDocuments references rank as a regular column. In FTS5, rank is available for ORDER BY but not as a selected column in the standard way. Fix the SQL query.",
      "acceptanceCriteria": [
        "Run `cd Margin && swift build` - exits with code 0",
        "File `Margin/Sources/Margin/Database/SearchStore.swift` uses valid FTS5 rank syntax in the search query"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    }
  ]
}
